{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-pencil"></i> Edit Inventory Item: {{ item.ja_id }}</h2>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-warning" onclick="showItemHistory('{{ item.ja_id }}')">
            <i class="bi bi-clock-history"></i> View History
        </button>
        <a href="{{ url_for('main.inventory_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> View All Items
        </a>
    </div>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-messages">
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<form id="add-item-form" novalidate method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Alert for messages -->
    <div id="form-alerts"></div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="ja_id" class="form-label">JA ID *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="ja_id" name="ja_id" 
                                       value="{{ item.ja_id }}" required
                                       title="Format: JA followed by 6 digits">
                                <button type="button" class="btn btn-outline-secondary" id="suggest-ja-id-btn" 
                                        title="Generate next JA ID">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" id="print-label-btn" title="Print label">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Please provide a valid JA ID (format: JA000001).
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="item_type" class="form-label">Type *</label>
                            <select class="form-select" id="item_type" name="item_type" required>
                                <option value="">Select type...</option>
                                {% for type in ItemType %}
                                    <option value="{{ type.value }}" {% if item.item_type == type.value %}selected{% endif %}>{{ type.value }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Please select an item type.
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="shape" class="form-label">Shape *</label>
                            <select class="form-select" id="shape" name="shape" required>
                                <option value="">Select shape...</option>
                                {% for shape in ItemShape %}
                                    <option value="{{ shape.value }}" {% if item.shape == shape.value %}selected{% endif %}>{{ shape.value }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Please select a shape.
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="material" class="form-label">Material *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="material" name="material" 
                                       value="{{ item.material }}" required autocomplete="off"
                                       >
                                <div id="material-suggestions" class="dropdown-menu position-absolute w-100" 
                                     style="max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                            </div>
                            <div class="invalid-feedback">
                                Please specify the material.
                            </div>
                            <small class="form-text text-muted">Start typing to see suggestions from your inventory</small>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" 
                                   min="1" value="{{ item.quantity }}">
                        </div>
                        
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="active" name="active" 
                                       {% if item.active %}checked{% endif %}>
                                <label class="form-check-label" for="active">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dimensions -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-rulers"></i> Dimensions</h5>
                    <small class="text-muted">All dimensions in inches</small>
                </div>
                <div class="card-body">
                    <!-- Required dimensions message -->
                    <div id="required-dimensions-info" class="alert alert-info d-none">
                        <i class="bi bi-info-circle"></i>
                        <span id="required-dimensions-text"></span>
                    </div>
                    
                    <div class="row" id="dimensions-row">
                        <div class="col-md-3 mb-3">
                            <label for="length" class="form-label">Length *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="length" name="length" 
                                       value="{{ item.dimensions.length if item.dimensions.length }}" 
                                       step="any">
                                <span class="input-group-text">"</span>
                            </div>
                            <div class="invalid-feedback">
                                Length is required.
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3" id="width-field">
                            <label for="width" class="form-label" id="width-label">Width *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="width" name="width" 
                                       value="{{ item.dimensions.width if item.dimensions.width }}" 
                                       step="any">
                                <span class="input-group-text">"</span>
                            </div>
                            <div class="invalid-feedback">
                                Width is required.
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3" id="thickness-field">
                            <label for="thickness" class="form-label">Thickness</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="thickness" name="thickness" 
                                       value="{{ item.dimensions.thickness if item.dimensions.thickness }}" 
                                       step="any">
                                <span class="input-group-text">"</span>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3" id="wall-thickness-field">
                            <label for="wall_thickness" class="form-label">Wall Thickness</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="wall_thickness" name="wall_thickness" 
                                       value="{{ item.dimensions.wall_thickness if item.dimensions.wall_thickness }}" 
                                       step="any">
                                <span class="input-group-text">"</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="weight" class="form-label">Weight</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="weight" name="weight" 
                                       value="{{ item.dimensions.weight if item.dimensions.weight }}" 
                                       step="any">
                                <span class="input-group-text">lbs</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Threading (Conditional) -->
            <div class="card mb-4" id="threading-section" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-nut"></i> Threading</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="thread_size" class="form-label">Thread Size</label>
                            <input type="text" class="form-control" id="thread_size" name="thread_size" 
                                   value="{{ item.thread.size if item.thread and item.thread.size }}" 
                                    
                                   title="Examples: 1/2-13, M12x1.75, #10-24">
                            <div class="form-text">Examples: 1/2-13, M12x1.75, #10-24</div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="thread_series" class="form-label">Thread Series</label>
                            <select class="form-select" id="thread_series" name="thread_series">
                                <option value="">Select series...</option>
                                {% for thread_series in ThreadSeries %}
                                <option value="{{ thread_series.value }}" {% if item.thread and item.thread.series and item.thread.series.value == thread_series.value %}selected{% endif %}>{{ thread_series.value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="thread_handedness" class="form-label">Handedness</label>
                            <select class="form-select" id="thread_handedness" name="thread_handedness">
                                <option value="">Select handedness...</option>
                                <option value="RH" {% if item.thread and item.thread.handedness and item.thread.handedness.value == 'RH' %}selected{% endif %}>Right-Hand (RH)</option>
                                <option value="LH" {% if item.thread and item.thread.handedness and item.thread.handedness.value == 'LH' %}selected{% endif %}>Left-Hand (LH)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Photos -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-camera"></i> Photos</h5>
                    <small class="text-muted">Upload photos of this item</small>
                </div>
                <div class="card-body">
                    <div id="photo-manager-container">
                        <!-- Photo upload and gallery will be initialized here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Location -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Location</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location" 
                               value="{{ item.location if item.location }}" 
                               >
                    </div>
                    <div class="mb-3">
                        <label for="sub_location" class="form-label">Sub-location</label>
                        <input type="text" class="form-control" id="sub_location" name="sub_location" 
                               value="{{ item.sub_location if item.sub_location }}" 
                               >
                    </div>
                </div>
            </div>
            
            <!-- Purchase Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Purchase Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="purchase_date" class="form-label">Purchase Date</label>
                        <input type="date" class="form-control" id="purchase_date" name="purchase_date" 
                               value="{{ item.purchase_date.strftime('%Y-%m-%d') if item.purchase_date }}">
                    </div>
                    <div class="mb-3">
                        <label for="purchase_price" class="form-label">Purchase Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="purchase_price" name="purchase_price" 
                                   value="{{ item.purchase_price if item.purchase_price }}" 
                                   step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="purchase_location" class="form-label">Purchase Location</label>
                        <input type="text" class="form-control" id="purchase_location" name="purchase_location" 
                               value="{{ item.purchase_location if item.purchase_location }}" 
                               >
                    </div>
                    <div class="mb-3">
                        <label for="vendor" class="form-label">Vendor</label>
                        <input type="text" class="form-control" id="vendor" name="vendor" 
                               value="{{ item.vendor if item.vendor }}" 
                               >
                    </div>
                    <div class="mb-3">
                        <label for="vendor_part_number" class="form-label">Vendor Part Number</label>
                        <input type="text" class="form-control" id="vendor_part_number" name="vendor_part_number" 
                               value="{{ item.vendor_part_number if item.vendor_part_number }}" 
                               >
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-card-text"></i> Notes</h5>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="notes" name="notes" rows="4" 
                              >{{ item.notes if item.notes }}</textarea>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
        <div>
            <a href="{{ url_for('main.inventory_list') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Cancel
            </a>
        </div>
        <div>
            <button type="submit" class="btn btn-primary btn-submit" name="submit_type" value="save">
                <i class="bi bi-check-circle"></i> Update Item
            </button>
        </div>
    </div>
</form>

<!-- History Modal -->
<div class="modal fade" id="item-history-modal" tabindex="-1" aria-labelledby="item-history-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="item-history-modal-label">
                    <i class="bi bi-clock-history"></i> Item History - <span id="history-item-id"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="history-modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="edit-item-from-history-link">
                    <i class="bi bi-pencil"></i> Edit Item
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Make valid materials available globally
window.validMaterials = {{ valid_materials | tojson }};
</script>
<script src="{{ url_for('static', filename='js/material-validation.js') }}"></script>
<script src="{{ url_for('static', filename='js/material-selector.js') }}"></script>
<script src="{{ url_for('static', filename='js/label-printing-modal.js') }}"></script>
<script>
// Edit form functionality (simplified version without complex add form features)
document.addEventListener('DOMContentLoaded', function() {
    // Update form title
    document.title = 'Edit {{ item.ja_id }} - Workshop Inventory';
    
    const form = document.getElementById('add-item-form');
    const itemType = document.getElementById('item_type');
    const shape = document.getElementById('shape');
    
    // Basic type/shape change handlers for field visibility
    function updateFieldVisibility() {
        const typeValue = itemType.value;
        const shapeValue = shape.value;
        
        // Show/hide threading section for Threaded Rod
        const threadingSection = document.getElementById('threading-section');
        if (threadingSection) {
            if (typeValue === 'Threaded Rod') {
                threadingSection.style.display = 'block';
            } else {
                threadingSection.style.display = 'none';
            }
        }
        
        // Update width label for round items
        const widthLabel = document.getElementById('width-label');
        if (widthLabel) {
            if (shapeValue === 'Round') {
                widthLabel.textContent = 'Diameter *';
            } else {
                widthLabel.textContent = 'Width *';
            }
        }
    }
    
    // Set up event listeners
    if (itemType) {
        itemType.addEventListener('change', updateFieldVisibility);
    }
    if (shape) {
        shape.addEventListener('change', updateFieldVisibility);
    }
    
    // Initialize field visibility based on current values
    updateFieldVisibility();
    
    // Initialize photo manager
    initializePhotoManager();
    
    // Add Generate JA ID functionality  
    const generateJaIdBtn = document.getElementById('suggest-ja-id-btn');
    if (generateJaIdBtn) {
        generateJaIdBtn.addEventListener('click', async function() {
            const jaIdInput = document.getElementById('ja_id');
            
            // Disable button and show loading state
            generateJaIdBtn.disabled = true;
            const originalHTML = generateJaIdBtn.innerHTML;
            generateJaIdBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
            try {
                const response = await fetch('/api/inventory/next-ja-id');
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to generate JA ID');
                }
                
                // Set the generated ID
                jaIdInput.value = data.next_ja_id;
                
                // Show success message (simple alert for edit form)
                alert(`Generated JA ID: ${data.next_ja_id}`);
                
            } catch (error) {
                console.error('Error generating JA ID:', error);
                alert(`Failed to generate JA ID: ${error.message}`);
            } finally {
                // Restore button state
                generateJaIdBtn.disabled = false;
                generateJaIdBtn.innerHTML = originalHTML;
            }
        });
    }
    
    // Add Print Label functionality
    const printLabelBtn = document.getElementById('print-label-btn');
    if (printLabelBtn) {
        printLabelBtn.addEventListener('click', async function() {
            const jaId = document.getElementById('ja_id').value.trim();
            if (jaId && jaId.match(/^JA\d{6}$/)) {
                // Show modal without persistence for Edit Item form
                await showLabelPrintingModal(jaId, false);
            } else {
                alert('Please enter a valid JA ID before printing a label');
            }
        });
    }
    
    // Wait for form to be fully populated, then re-run validation to clear false errors
    setTimeout(function() {
        // Remove any existing validation classes
        form.classList.remove('was-validated');
        const fields = form.querySelectorAll('.is-invalid, .is-valid');
        fields.forEach(field => {
            field.classList.remove('is-invalid', 'is-valid');
        });
        
        // Re-trigger validation now that form is populated
        if (form.checkValidity()) {
            // If form is valid, ensure no error states are showing
            const invalidFeedbacks = form.querySelectorAll('.invalid-feedback');
            invalidFeedbacks.forEach(feedback => {
                feedback.style.display = 'none';
            });
        }
        
        // Now enable Bootstrap validation for future interactions
        form.classList.add('needs-validation');
    }, 100);
    
    // Set up material autocomplete (same as Add form)
    function setupMaterialAutocomplete() {
        const materialInput = document.getElementById('material');
        const suggestionsDiv = document.getElementById('material-suggestions');
        
        if (!materialInput || !suggestionsDiv) {
            console.warn('Material autocomplete elements not found');
            return;
        }
        
        materialInput.addEventListener('input', WorkshopInventory.utils.debounce(async (e) => {
            const query = e.target.value.trim();
            if (query.length >= 1) {
                await showMaterialMatches(query);
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }, 200));
        
        // Show initial suggestions when field is focused
        materialInput.addEventListener('focus', async () => {
            const query = materialInput.value.trim();
            if (query.length >= 1) {
                await showMaterialMatches(query);
            } else {
                // Show categories when no query
                await showMaterialMatches('');
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#material') && !e.target.closest('#material-suggestions')) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }
    
    async function showMaterialMatches(query) {
        const suggestionsDiv = document.getElementById('material-suggestions');
        
        try {
            // Build API query
            const params = new URLSearchParams();
            if (query) {
                params.append('q', query);
            }
            params.append('limit', '10');
            
            const response = await fetch(`/api/materials/suggestions?${params}`);
            if (!response.ok) {
                throw new Error('Failed to fetch suggestions');
            }
            
            const matches = await response.json();
            
            if (matches.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const html = matches.map(material => 
                `<a class="dropdown-item" href="#" data-material="${material}">${material}</a>`
            ).join('');
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
            
            // Add click handlers
            suggestionsDiv.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const materialInput = document.getElementById('material');
                    materialInput.value = item.dataset.material;
                    suggestionsDiv.style.display = 'none';
                    
                    // Trigger validation events to clear validation state
                    materialInput.dispatchEvent(new Event('input', { bubbles: true }));
                    materialInput.dispatchEvent(new Event('change', { bubbles: true }));
                    materialInput.dispatchEvent(new Event('blur', { bubbles: true }));
                });
            });
            
        } catch (error) {
            console.warn('Failed to fetch material suggestions:', error);
            // Fallback to hiding suggestions
            suggestionsDiv.style.display = 'none';
        }
    }
    
    // Only set up old autocomplete if MaterialSelector is not active
    if (!window.MATERIAL_SELECTOR_ACTIVE) {
        console.log('EditForm: Setting up old autocomplete');
        setupMaterialAutocomplete();
    } else {
        console.log('EditForm: MaterialSelector is active, skipping old autocomplete');
    }
    
    // Prevent Enter key submission for barcode scanner fields
    function setupEnterKeyPrevention() {
        // Prevent Enter key from submitting form when pressed in JA ID or Location fields
        // This is needed because barcode scanners send Enter after scanning
        const fieldsToPrevent = ['ja_id', 'location'];
        
        fieldsToPrevent.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // Move focus to next field instead of submitting
                        const nextField = getNextField(field);
                        if (nextField) {
                            nextField.focus();
                        }
                    }
                });
            }
        });
    }
    
    function getNextField(currentField) {
        // Get all focusable form elements
        const formElements = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
        const elementsArray = Array.from(formElements);
        const currentIndex = elementsArray.indexOf(currentField);
        
        // Return next focusable element, or null if it's the last one
        return elementsArray[currentIndex + 1] || null;
    }
    
    // Set up Enter key prevention
    setupEnterKeyPrevention();
    
    // Initialize photo manager for editing existing item
    function initializePhotoManager() {
        if (typeof PhotoManager !== 'undefined') {
            console.log('Initializing PhotoManager for Edit Item form');
            window.editPhotoManager = PhotoManager.init('#photo-manager-container', {
                readOnly: false,
                itemId: '{{ item.ja_id }}' // Use the current item's JA ID
            });
            console.log('PhotoManager initialized successfully for item {{ item.ja_id }}');
        } else {
            console.warn('PhotoManager not available');
        }
    }
    
    // Handle form submission with validation
    form.addEventListener('submit', function(event) {
        // Re-enable feedback display for submission validation
        const invalidFeedbacks = form.querySelectorAll('.invalid-feedback');
        invalidFeedbacks.forEach(feedback => {
            feedback.style.display = '';
        });
        
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
<script src="{{ url_for('static', filename='js/history-viewer.js') }}"></script>
{% endblock %}